
if(!Function.prototype.bind){Function.prototype.bind=function(a){if(typeof this!=="function"){throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable")}var e=Array.prototype.slice.call(arguments,1),d=this,b=function(){},c=function(){return d.apply(this instanceof b&&a?this:a,e.concat(Array.prototype.slice.call(arguments)))};b.prototype=this.prototype;c.prototype=new b();return c}}window.VoxImplantJSON={parse:function(sJSON){return eval("("+sJSON+")")},stringify:function(b){if(b instanceof Object){var d="";if(b.constructor===Array){for(var a=0;a<b.length;d+=this.stringify(b[a])+",",a++){}return"["+d.substr(0,d.length-1)+"]"}if(b.toString!==Object.prototype.toString){return'"'+b.toString().replace(/"/g,"\\$&")+'"'}for(var c in b){d+='"'+c.replace(/"/g,"\\$&")+'":'+this.stringify(b[c])+","}return"{"+d.substr(0,d.length-1)+"}"}else{if(typeof b==="undefined"||b===NaN||b===Infinity||b===-Infinity){return null}else{if(typeof b==="number"||b===true||b===false){return b}else{if(typeof b==="string"){return'"'+b.replace(/"/g,"\\$&")+'"'}else{return null}}}}}};if(!window.JSON){window.JSON=window.VoxImplantJSON}(function(VoxImplant,undefined){VoxImplant.Utils={source:null,swfMovie:function(movieName){if(navigator.appName.indexOf("Microsoft")!=-1){return window[movieName]}else{return document[movieName]}},stringifyExtraHeaders:function(headersObj){if(Object.prototype.toString.call(headersObj)=="[object Object]"){headersObj=JSON.stringify(headersObj)}else{headersObj=null}return headersObj},cadScript:function(script){var cads=script.split(";");return cads.map(function(cad){if(cad.length===0){return}var matchParens=cad.match(/\([0-9\/\.,\*\+]*\)$/),ringLength=cad.substring(0,matchParens.index),segments=matchParens.pop();if(matchParens.length){throw new Error("cadence script should be of the form `%f(%f/%f[,%f/%f])`")}ringLength=(ringLength==="*")?Infinity:parseFloat(ringLength);if(isNaN(ringLength)){throw new Error("cadence length should be of the form `%f`")}segments=segments.slice(1,segments.length-1).split(",").map(function(segment){try{var onOff=segment.split("/");if(onOff.length>3){throw new Error()}onOff=onOff.map(function(string,i){if(i===2){var freqs=string.split("+").map(function(f){var integer=parseInt(f,10);if(isNaN(integer)){throw new Error()}return integer-1});return freqs}var flt;if(string=="*"){flt=Infinity}flt=flt?flt:parseFloat(string,10);if(isNaN(flt)){throw new Error()}return flt});return{on:onOff[0],off:onOff[1],frequencies:onOff[2]}}catch(err){throw new Error("cadence segments should be of the form `%f/%f[%d[+%d]]`")}});return{duration:ringLength,sections:segments}})},freqScript:function(script){var freqs=script.split(",");return freqs.map(function(freq){try{var tonePair=freq.split("@"),frequency=parseInt(tonePair.shift()),dB=parseFloat(tonePair.shift());if(tonePair.length){throw Error()}return{frequency:frequency,decibels:dB}}catch(err){throw new Error("freqScript pairs are expected to be of the form `%d@%f[,%d@%f]`")}})},toneScript:function(script){var sections=script.split(";"),frequencies=VoxImplant.Utils.freqScript(sections.shift()),cadences=VoxImplant.Utils.cadScript(sections.join(";"));return{frequencies:frequencies,cadences:cadences}},playToneScript:function(script,loop){if(typeof window.AudioContext!="undefined"||typeof window.webkitAudioContext!="undefined"){window.AudioContext=window.AudioContext||window.webkitAudioContext;var context=new AudioContext(),parsedToneScript=VoxImplant.Utils.toneScript(script),samples=[],fullDuration=0;function processCadence(cadence){if(cadence.duration!=Infinity){fullDuration+=cadence.duration}else{fullDuration+=20}for(var i=0;i<cadence.sections.length;i++){processSection(cadence.sections[i],cadence.duration)}}function processSection(section,duration){if(duration!=Infinity){t=duration}else{t=duration=20}if(section.off!=0&&section.off!=Infinity){while(t>0){addSound(section.frequencies,section.on);t-=section.on;addSilence(section.off);t-=section.off;t=parseInt((t)*10)/10}}else{addSound(section.frequencies,duration)}}function addSilence(sec){for(var t=0;t<context.sampleRate*sec;t++){samples.push(0)}}function addSound(freq,sec){for(var t=0;t<context.sampleRate*sec;t++){var sample=0;for(var f=0;f<freq.length;f++){sample+=Math.pow(10,parsedToneScript.frequencies[freq[f]].decibels/20)*Math.sin((samples.length+t)*(3.14159265359/context.sampleRate)*parsedToneScript.frequencies[freq[f]].frequency);if(t<10){sample*=(t/10)}if(t>(context.sampleRate*sec-10)){sample*=(context.sampleRate*sec-t)/10}}samples.push(sample)}}this.source=context.createBufferSource();for(var k=0;k<parsedToneScript.cadences.length;k++){if(parsedToneScript.cadences[k].duration==Infinity){this.source.loop=true}processCadence(parsedToneScript.cadences[k])}this.source.connect(context.destination);sndBuffer=context.createBuffer(1,fullDuration*context.sampleRate,context.sampleRate);bufferData=sndBuffer.getChannelData(0);for(var i=0;i<fullDuration*context.sampleRate;i++){bufferData[i]=samples[i]}samples=null;this.source.buffer=sndBuffer;if(loop===true){this.source.loop=true}this.source.start(0)}},stopPlayback:function(){if(this.source!=null){this.source.stop(0);this.source=null;return true}return false},sendRequest:function(url,callback,error,postData){var xdr=false;var createXMLHTTPObject=function(){var XMLHttpFactories=[function(){return new XDomainRequest()},function(){return new XMLHttpRequest()},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Msxml3.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")}];var xmlhttp=false;for(var i=0;i<XMLHttpFactories.length;i++){try{xmlhttp=XMLHttpFactories[i]();if(i==0){xdr=true}}catch(e){continue}break}return xmlhttp};var req=createXMLHTTPObject();if(!req){return}var method=(postData)?"POST":"GET";if(!xdr){req.open(method,url,true);if(postData){req.setRequestHeader("Content-type","application/x-www-form-urlencoded")}req.onreadystatechange=function(){if(req.readyState!=4){return}if(req.status!=200&&req.status!=304){error(req);return}callback(req)};if(req.readyState==4){return}req.send(postData)}else{req.onerror=function(){error(req)};req.ontimeout=function(){error(req)};req.onload=function(){callback(req)};req.open(method,url);req.timeout=5000;req.send()}},getServers:function(callback,reservedBalancer,vi){var protocol=("https:"==document.location.protocol?"https://":"http://");if(reservedBalancer===true){balancer_url=protocol+"balancer2.voximplant.com/getNearestHost?result_mode=JSONP&jsonp_callback=balancerComplete"}else{balancer_url=protocol+"balancer.voximplant.com/getNearestHost?result_mode=JSONP&jsonp_callback=balancerComplete"}VoxImplant.Utils.sendRequest(balancer_url,function(XHR){eval(XHR.responseText)},function(XHR){balancerComplete(null)});function balancerComplete(data){if(data!=null){callback(data)}else{if(reservedBalancer!==true){VoxImplant.Utils.getServers(callback,true,vi)}else{vi.dispatchEvent({name:"ConnectionFailed",message:"VoxImplant Cloud is unavailable"})}}}}};VoxImplant.Call=function(c,n,dn,headers,RTC,api){var _RTC=RTC;var _call=c;var _num=n;var _displayName=dn;var _headers=headers;var _zingayaAPI=api;this.eventListeners={};this.call=function(pid){if(typeof pid=="undefined"){return _call}else{_call=pid}};this.__number=function(pnum){if(typeof pnum=="undefined"){return _num}else{_num=pnum}};this.__displayName=function(){return _displayName};this.__headers=function(){return _headers};this.RTC=function(){return _RTC};this.zingayaAPI=function(){return _zingayaAPI}};VoxImplant.Call.prototype={id:function(){return this.RTC()?this.call().id():this.call()},number:function(){return this.__number()},displayName:function(){return this.__displayName()},headers:function(){return this.__headers()},state:function(){return this.RTC()?this.call().state():VoxImplant.Utils.swfMovie("voximplantSWF").getCallState(this.call())},answer:function(customData,extraHeaders){if(typeof customData!="undefined"){if(typeof extraHeaders=="undefined"){extraHeaders=new Object()}extraHeaders["VI-CallData"]=customData}if(this.RTC()){if(this.call().state()!="ALERTING"){throw new Error("NO_INCOMING_CALL")}this.zingayaAPI().accept(this.call(),extraHeaders)}else{extraHeaders=JSON.stringify(extraHeaders);VoxImplant.Utils.swfMovie("voximplantSWF").accept(this.call(),extraHeaders)}},decline:function(extraHeaders){if(this.RTC()){if(this.call().state()!="ALERTING"){throw new Error("NO_INCOMING_CALL")}this.zingayaAPI().hangup(this.call(),extraHeaders)}else{extraHeaders=VoxImplant.Utils.stringifyExtraHeaders(extraHeaders);VoxImplant.Utils.swfMovie("voximplantSWF").reject(this.call(),extraHeaders)}},hangup:function(extraHeaders){if(this.RTC()){if(this.call().state()=="CONNECTED"||this.call().state()=="PROGRESSING"){this.zingayaAPI().hangup(this.call(),extraHeaders)}else{throw new Error("WRONG_CALL_STATE")}}else{extraHeaders=VoxImplant.Utils.stringifyExtraHeaders(extraHeaders);VoxImplant.Utils.swfMovie("voximplantSWF").disconnectCall(this.call(),extraHeaders)}},sendTone:function(key){if(key=="*"){key=10}else{if(key=="#"){key=11}else{key=parseInt(key);if(key<0||key>9){throw new Error("WRONG_TONE_INPUT")}}}if(this.RTC()){if(this.call().state()!="CONNECTED"){throw new Error("CALL_NOT_CONNECTED")}this.zingayaAPI().sendDigit(this.call(),key)}else{VoxImplant.Utils.swfMovie("voximplantSWF").sendDTMF(key,this.call())}},mutePlayback:function(){if(this.RTC()){this.zingayaAPI().mutePlayback()}else{VoxImplant.Utils.swfMovie("voximplantSWF").muteIncomingAudio(this.call())}},muteMicrophone:function(){if(this.RTC()){this.zingayaAPI().muteMicrophone()}else{VoxImplant.Utils.swfMovie("voximplantSWF").muteOutgoingAudio(this.call())}},unmutePlayback:function(){if(this.RTC()){this.zingayaAPI().unmutePlayback()}else{VoxImplant.Utils.swfMovie("voximplantSWF").unmuteIncomingAudio(this.call())}},unmuteMicrophone:function(){if(this.RTC()){this.zingayaAPI().unmuteMicrophone()}else{VoxImplant.Utils.swfMovie("voximplantSWF").unmuteOutgoingAudio(this.call())}},showRemoteVideo:function(flag){if(typeof flag=="undefined"){flag=true}if(this.RTC()){document.getElementById("voximplantcontainer").style.display=(flag?"block":"none")}else{VoxImplant.Utils.swfMovie("voximplantSWF").showRemoteVideo(this.call(),flag)}},sendVideo:function(flag){if(typeof flag=="undefined"){flag=true}if(this.RTC()){this.zingayaAPI().localVideoTracksEnabled(flag)}else{VoxImplant.Utils.swfMovie("voximplantSWF").sendVideo(this.call(),flag)}},setRemoteVideoPosition:function(x,y){if(this.RTC()){throw new Error("Please use CSS to position '#voximplantcontainer' element")}else{VoxImplant.Utils.swfMovie("voximplantSWF").setRemoteViewPosition(x,y)}},setRemoteVideoSize:function(width,height){if(this.RTC()){throw new Error("Please use CSS to set size of '#voximplantcontainer' element")}else{VoxImplant.Utils.swfMovie("voximplantSWF").setRemoteViewSize(this.call(),width,height)}},sendInfo:function(mimeType,body,extraHeaders){var type,subtype,i=mimeType.indexOf("/");if(i==-1){type="application";subtype=mimeType}else{type=mimeType.substring(0,i);subtype=mimeType.substring(i+1)}if(this.RTC()){if(this.call().state()!="CONNECTED"){throw new Error("CALL_NOT_CONNECTED")}this.zingayaAPI().sendSIPInfo(this.call(),type,subtype,body,extraHeaders)}else{extraHeaders=VoxImplant.Utils.stringifyExtraHeaders(extraHeaders);VoxImplant.Utils.swfMovie("voximplantSWF").sendSIPInfo(this.call(),type,subtype,body,extraHeaders)}},sendMessage:function(msg){if(this.RTC()){if(this.call().state()!="CONNECTED"){throw new Error("CALL_NOT_CONNECTED")}this.zingayaAPI().sendInstantMessage(this.call(),msg)}else{VoxImplant.Utils.swfMovie("voximplantSWF").sendMessage(this.call(),msg)}},setVideoSettings:function(settings,successCallback,failedCallback){if(this.RTC()){this.zingayaAPI().setConstraints(settings,successCallback,failedCallback)}else{if(!this.useRTCOnly){if(Object.prototype.toString.call(settings)=="[object Object]"){settings=JSON.stringify(settings)}VoxImplant.Utils.swfMovie("voximplantSWF").setVideoSettings(settings,this.call())}}}};VoxImplant.Client=function(){this.config=null;this.calls=new Array();var Call=VoxImplant.Call;delete VoxImplant.Call;var _connected=false;this.eventListeners={};this.progressToneScript={US:"440@-19,480@-19;*(2/4/1+2)",RU:"425@-19;*(1/3/1)"};this.playingNow=false;this.serversList=new Array();var _vol=100;this.audioSourcesList=new Array();this.videoSourcesList=new Array();this.deviceEnumAPI=(typeof MediaStreamTrack!="undefined")&&(typeof MediaStreamTrack.getSources!="undefined");this.gotSources=function(sourceInfos){if(this.audioSourcesList.length!=0){this.audioSourcesList=new Array()}if(this.videoSourcesList.length!=0){this.videoSourcesList=new Array()}var v=0,a=0;for(var i=0;i!=sourceInfos.length;++i){var sourceInfo=sourceInfos[i];if(sourceInfo.kind==="audio"){a++;this.audioSourcesList.push({id:sourceInfo.id,name:sourceInfo.label||"Audio recording device "+a})}else{if(sourceInfo.kind==="video"){v++;this.videoSourcesList.push({id:sourceInfo.id,name:sourceInfo.label||"Video recording device "+v})}}}this.dispatchEvent({name:"SourcesInfoUpdated"})}.bind(this),this.__init=function(config){if(this.config!=null){throw ("VoxImplant.Client has been already initialized")}this.config=typeof config!=="undefined"?config:{};if(this.config.useFlashOnly===true){this.useFlashOnly=true}else{this.useFlashOnly=false}if(this.config.useRTCOnly===true){this.useRTCOnly=true}else{this.useRTCOnly=false}this.RTCsupported=false;if(this.config.micRequired!==false){this.micRequired=true}else{this.micRequired=false}if(this.config.videoSupport!==true){this.videoSupport=false}else{this.videoSupport=true}if(typeof this.config.swfContainer!="undefined"){this.swfContainer=this.config.swfContainer}else{this.swfContainer=null}if(typeof this.config.progressToneCountry!="undefined"){this.progressToneCountry=this.config.progressToneCountry}else{this.progressToneCountry="US"}if(this.config.progressTone!==true){this.progressTone=false}else{this.progressTone=true}if(this.config.showFlashSettings===true){this.showFlashSettings=true}else{this.showFlashSettings=false}if(typeof this.config.serverIp!="undefined"){this.serverIp=this.config.serverIp}if(typeof(webkitRTCPeerConnection)!="undefined"||(typeof(mozRTCPeerConnection)!="undefined")){if(typeof(mozRTCPeerConnection)!="undefined"){try{var testPC=new mozRTCPeerConnection({iceServers:[]});this.RTCsupported=true}catch(e){}}else{this.RTCsupported=true}}if(this.RTCsupported&&!this.useFlashOnly){this.zingayaAPI=new VoxImplant.ZingayaAPI(this.videoSupport);delete VoxImplant.ZingayaAPI;this.zingayaAPI.connectionSuccessCallback=function(){this.connectionState(true);this.dispatchEvent({name:"ConnectionEstablished"})}.bind(this);this.zingayaAPI.connectionFailedCallback=function(msg){if(this.serversList.length>1&&typeof(this.serverIp)=="undefined"){this.serversList.splice(0,1);this.connectTo(this.serversList[0],true)}else{this.dispatchEvent({name:"ConnectionFailed",message:msg})}}.bind(this);this.zingayaAPI.connectionClosedCallback=function(){this.connectionState(false);this.dispatchEvent({name:"ConnectionClosed"});if(this.progressTone){this.stopProgressTone()}}.bind(this);this.zingayaAPI.loginSuccessCallback=function(){this.dispatchEvent({name:"AuthResult",result:true})}.bind(this);this.zingayaAPI.loginFailedCallback=function(obj){this.dispatchEvent({name:"AuthResult",result:false,code:obj.errorCode,key:obj.oneTimeKey})}.bind(this);this.zingayaAPI.onCallConnected=function(call){this.getCall(call).dispatchEvent({name:"Connected",call:this.getCall(call)});if(this.progressTone){this.stopProgressTone()}}.bind(this);this.zingayaAPI.onCallDisconnected=function(call){this.getCall(call).dispatchEvent({name:"Disconnected",call:this.getCall(call)});this.removeCall(call);if(this.progressTone){this.stopProgressTone()}}.bind(this);this.zingayaAPI.onCallFailed=function(call,code,reason){this.getCall(call).dispatchEvent({name:"Failed",call:this.getCall(call),code:code,reason:reason});this.removeCall(call);if(this.progressTone){this.stopProgressTone()}}.bind(this);this.onMicAccessAllowed=function(){if(this.deviceEnumAPI){MediaStreamTrack.getSources(this.gotSources)}if(this.micRequired){this.zingayaAPI.connectTo(this.host,"platform")}this.dispatchEvent({name:"MicAccessResult",result:true})}.bind(this);this.onMicAccessDenied=function(){this.dispatchEvent({name:"MicAccessResult",result:false})}.bind(this);this.zingayaAPI.onIncomingCall=function(call,headers){var newCall=new Call(call,call.remote(),call.remoteDisplayName(),headers,true,this.zingayaAPI);this.calls.push(newCall);this.dispatchEvent({name:"IncomingCall",call:newCall})}.bind(this);this.zingayaAPI.onPlayProgressTone=function(call){this.getCall(call).dispatchEvent({name:"ProgressToneStart",call:this.getCall(call)});if(this.progressTone){this.playProgressTone()}}.bind(this);this.zingayaAPI.onStopPlayingProgressTone=function(call){this.getCall(call).dispatchEvent({name:"ProgressToneStop",call:this.getCall(call)});if(this.progressTone){this.stopProgressTone()}}.bind(this);this.zingayaAPI.onMessage=function(call,body){this.getCall(call).dispatchEvent({name:"MessageReceived",call:this.getCall(call),text:body})}.bind(this);this.zingayaAPI.onSIPInfo=function(call,mime,body,headers){this.getCall(call).dispatchEvent({name:"InfoReceived",call:this.getCall(call),mimeType:mime,body:body,headers:headers})}.bind(this);function checkDOMReady(){if(typeof document!="undefined"){clearInterval(ts);var element=document.createElement("video");element.id="voximplantcontainer";element.autoplay="true";if(!this.videoSupport){element.style.display="none"}if(document.body.firstChild){document.body.insertBefore(element,document.body.firstChild)}else{document.body.appendChild(element)}this.zingayaAPI.setAudioSink(element);this.dispatchEvent({name:"SDKReady"});if(this.deviceEnumAPI){MediaStreamTrack.getSources(this.gotSources)}}}var ts=setInterval(checkDOMReady.bind(this),100)}else{if(!this.useRTCOnly){var swfobject=function(){var D="undefined",r="object",S="Shockwave Flash",W="ShockwaveFlash.ShockwaveFlash",q="application/x-shockwave-flash",R="SWFObjectExprInst",x="onreadystatechange",O=window,j=document,t=navigator,T=false,U=[h],o=[],N=[],I=[],l,Q,E,B,J=false,a=false,n,G,m=true,M=function(){var aa=typeof j.getElementById!=D&&typeof j.getElementsByTagName!=D&&typeof j.createElement!=D,ah=t.userAgent.toLowerCase(),Y=t.platform.toLowerCase(),ae=Y?/win/.test(Y):/win/.test(ah),ac=Y?/mac/.test(Y):/mac/.test(ah),af=/webkit/.test(ah)?parseFloat(ah.replace(/^.*webkit\/(\d+(\.\d+)?).*$/,"$1")):false,X=!+"\v1",ag=[0,0,0],ab=null;if(typeof t.plugins!=D&&typeof t.plugins[S]==r){ab=t.plugins[S].description;if(ab&&!(typeof t.mimeTypes!=D&&t.mimeTypes[q]&&!t.mimeTypes[q].enabledPlugin)){T=true;X=false;ab=ab.replace(/^.*\s+(\S+\s+\S+$)/,"$1");ag[0]=parseInt(ab.replace(/^(.*)\..*$/,"$1"),10);ag[1]=parseInt(ab.replace(/^.*\.(.*)\s.*$/,"$1"),10);ag[2]=/[a-zA-Z]/.test(ab)?parseInt(ab.replace(/^.*[a-zA-Z]+(.*)$/,"$1"),10):0}}else{if(typeof O.ActiveXObject!=D){try{var ad=new ActiveXObject(W);if(ad){ab=ad.GetVariable("$version");if(ab){X=true;ab=ab.split(" ")[1].split(",");ag=[parseInt(ab[0],10),parseInt(ab[1],10),parseInt(ab[2],10)]}}}catch(Z){}}}return{w3:aa,pv:ag,wk:af,ie:X,win:ae,mac:ac}}(),k=function(){if(!M.w3){return}if((typeof j.readyState!=D&&j.readyState=="complete")||(typeof j.readyState==D&&(j.getElementsByTagName("body")[0]||j.body))){f()}if(!J){if(typeof j.addEventListener!=D){j.addEventListener("DOMContentLoaded",f,false)}if(M.ie&&M.win){j.attachEvent(x,function(){if(j.readyState=="complete"){j.detachEvent(x,arguments.callee);f()}});if(O==top){(function(){if(J){return}try{j.documentElement.doScroll("left")}catch(X){setTimeout(arguments.callee,0);return}f()})()}}if(M.wk){(function(){if(J){return}if(!/loaded|complete/.test(j.readyState)){setTimeout(arguments.callee,0);return}f()})()}s(f)}}();function f(){if(J){return}try{var Z=j.getElementsByTagName("body")[0].appendChild(C("span"));Z.parentNode.removeChild(Z)}catch(aa){return}J=true;var X=U.length;for(var Y=0;Y<X;Y++){U[Y]()}}function K(X){if(J){X()}else{U[U.length]=X}}function s(Y){if(typeof O.addEventListener!=D){O.addEventListener("load",Y,false)}else{if(typeof j.addEventListener!=D){j.addEventListener("load",Y,false)}else{if(typeof O.attachEvent!=D){i(O,"onload",Y)}else{if(typeof O.onload=="function"){var X=O.onload;O.onload=function(){X();Y()}}else{O.onload=Y}}}}}function h(){if(T){V()}else{H()}}function V(){var X=j.getElementsByTagName("body")[0];var aa=C(r);aa.setAttribute("type",q);var Z=X.appendChild(aa);if(Z){var Y=0;(function(){if(typeof Z.GetVariable!=D){var ab=Z.GetVariable("$version");if(ab){ab=ab.split(" ")[1].split(",");M.pv=[parseInt(ab[0],10),parseInt(ab[1],10),parseInt(ab[2],10)]}}else{if(Y<10){Y++;setTimeout(arguments.callee,10);return}}X.removeChild(aa);Z=null;H()})()}else{H()}}function H(){var ag=o.length;if(ag>0){for(var af=0;af<ag;af++){var Y=o[af].id;var ab=o[af].callbackFn;var aa={success:false,id:Y};if(M.pv[0]>0){var ae=c(Y);if(ae){if(F(o[af].swfVersion)&&!(M.wk&&M.wk<312)){w(Y,true);if(ab){aa.success=true;aa.ref=z(Y);ab(aa)}}else{if(o[af].expressInstall&&A()){var ai={};ai.data=o[af].expressInstall;ai.width=ae.getAttribute("width")||"0";ai.height=ae.getAttribute("height")||"0";if(ae.getAttribute("class")){ai.styleclass=ae.getAttribute("class")}if(ae.getAttribute("align")){ai.align=ae.getAttribute("align")}var ah={};var X=ae.getElementsByTagName("param");var ac=X.length;for(var ad=0;ad<ac;ad++){if(X[ad].getAttribute("name").toLowerCase()!="movie"){ah[X[ad].getAttribute("name")]=X[ad].getAttribute("value")}}P(ai,ah,Y,ab)}else{p(ae);if(ab){ab(aa)}}}}}else{w(Y,true);if(ab){var Z=z(Y);if(Z&&typeof Z.SetVariable!=D){aa.success=true;aa.ref=Z}ab(aa)}}}}}function z(aa){var X=null;var Y=c(aa);if(Y&&Y.nodeName=="OBJECT"){if(typeof Y.SetVariable!=D){X=Y}else{var Z=Y.getElementsByTagName(r)[0];if(Z){X=Z}}}return X}function A(){return !a&&F("6.0.65")&&(M.win||M.mac)&&!(M.wk&&M.wk<312)}function P(aa,ab,X,Z){a=true;E=Z||null;B={success:false,id:X};var ae=c(X);if(ae){if(ae.nodeName=="OBJECT"){l=g(ae);Q=null}else{l=ae;Q=X}aa.id=R;if(typeof aa.width==D||(!/%$/.test(aa.width)&&parseInt(aa.width,10)<310)){aa.width="310"}if(typeof aa.height==D||(!/%$/.test(aa.height)&&parseInt(aa.height,10)<137)){aa.height="137"}j.title=j.title.slice(0,47)+" - Flash Player Installation";var ad=M.ie&&M.win?"ActiveX":"PlugIn",ac="MMredirectURL="+O.location.toString().replace(/&/g,"%26")+"&MMplayerType="+ad+"&MMdoctitle="+j.title;if(typeof ab.flashvars!=D){ab.flashvars+="&"+ac}else{ab.flashvars=ac}if(M.ie&&M.win&&ae.readyState!=4){var Y=C("div");X+="SWFObjectNew";Y.setAttribute("id",X);ae.parentNode.insertBefore(Y,ae);ae.style.display="none";(function(){if(ae.readyState==4){ae.parentNode.removeChild(ae)}else{setTimeout(arguments.callee,10)}})()}u(aa,ab,X)}}function p(Y){if(M.ie&&M.win&&Y.readyState!=4){var X=C("div");Y.parentNode.insertBefore(X,Y);X.parentNode.replaceChild(g(Y),X);Y.style.display="none";(function(){if(Y.readyState==4){Y.parentNode.removeChild(Y)}else{setTimeout(arguments.callee,10)}})()}else{Y.parentNode.replaceChild(g(Y),Y)}}function g(ab){var aa=C("div");if(M.win&&M.ie){aa.innerHTML=ab.innerHTML}else{var Y=ab.getElementsByTagName(r)[0];if(Y){var ad=Y.childNodes;if(ad){var X=ad.length;for(var Z=0;Z<X;Z++){if(!(ad[Z].nodeType==1&&ad[Z].nodeName=="PARAM")&&!(ad[Z].nodeType==8)){aa.appendChild(ad[Z].cloneNode(true))}}}}}return aa}function u(ai,ag,Y){var X,aa=c(Y);if(M.wk&&M.wk<312){return X}if(aa){if(typeof ai.id==D){ai.id=Y}if(M.ie&&M.win){var ah="";for(var ae in ai){if(ai[ae]!=Object.prototype[ae]){if(ae.toLowerCase()=="data"){ag.movie=ai[ae]}else{if(ae.toLowerCase()=="styleclass"){ah+=' class="'+ai[ae]+'"'}else{if(ae.toLowerCase()!="classid"){ah+=" "+ae+'="'+ai[ae]+'"'}}}}}var af="";for(var ad in ag){if(ag[ad]!=Object.prototype[ad]){af+='<param name="'+ad+'" value="'+ag[ad]+'" />'}}aa.outerHTML='<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"'+ah+">"+af+"</object>";N[N.length]=ai.id;X=c(ai.id)}else{var Z=C(r);Z.setAttribute("type",q);for(var ac in ai){if(ai[ac]!=Object.prototype[ac]){if(ac.toLowerCase()=="styleclass"){Z.setAttribute("class",ai[ac])}else{if(ac.toLowerCase()!="classid"){Z.setAttribute(ac,ai[ac])}}}}for(var ab in ag){if(ag[ab]!=Object.prototype[ab]&&ab.toLowerCase()!="movie"){e(Z,ab,ag[ab])}}aa.parentNode.replaceChild(Z,aa);X=Z}}return X}function e(Z,X,Y){var aa=C("param");aa.setAttribute("name",X);aa.setAttribute("value",Y);Z.appendChild(aa)}function y(Y){var X=c(Y);if(X&&X.nodeName=="OBJECT"){if(M.ie&&M.win){X.style.display="none";(function(){if(X.readyState==4){b(Y)}else{setTimeout(arguments.callee,10)}})()}else{X.parentNode.removeChild(X)}}}function b(Z){var Y=c(Z);if(Y){for(var X in Y){if(typeof Y[X]=="function"){Y[X]=null}}Y.parentNode.removeChild(Y)}}function c(Z){var X=null;try{X=j.getElementById(Z)}catch(Y){}return X}function C(X){return j.createElement(X)}function i(Z,X,Y){Z.attachEvent(X,Y);I[I.length]=[Z,X,Y]}function F(Z){var Y=M.pv,X=Z.split(".");X[0]=parseInt(X[0],10);X[1]=parseInt(X[1],10)||0;X[2]=parseInt(X[2],10)||0;return(Y[0]>X[0]||(Y[0]==X[0]&&Y[1]>X[1])||(Y[0]==X[0]&&Y[1]==X[1]&&Y[2]>=X[2]))?true:false}function v(ac,Y,ad,ab){if(M.ie&&M.mac){return}var aa=j.getElementsByTagName("head")[0];if(!aa){return}var X=(ad&&typeof ad=="string")?ad:"screen";if(ab){n=null;G=null}if(!n||G!=X){var Z=C("style");Z.setAttribute("type","text/css");Z.setAttribute("media",X);n=aa.appendChild(Z);if(M.ie&&M.win&&typeof j.styleSheets!=D&&j.styleSheets.length>0){n=j.styleSheets[j.styleSheets.length-1]}G=X}if(M.ie&&M.win){if(n&&typeof n.addRule==r){n.addRule(ac,Y)}}else{if(n&&typeof j.createTextNode!=D){n.appendChild(j.createTextNode(ac+" {"+Y+"}"))}}}function w(Z,X){if(!m){return}var Y=X?"visible":"hidden";if(J&&c(Z)){c(Z).style.visibility=Y}else{v("#"+Z,"visibility:"+Y)}}function L(Y){var Z=/[\\\"<>\.;]/;var X=Z.exec(Y)!=null;return X&&typeof encodeURIComponent!=D?encodeURIComponent(Y):Y}var d=function(){if(M.ie&&M.win){window.attachEvent("onunload",function(){var ac=I.length;for(var ab=0;ab<ac;ab++){I[ab][0].detachEvent(I[ab][1],I[ab][2])}var Z=N.length;for(var aa=0;aa<Z;aa++){y(N[aa])}for(var Y in M){M[Y]=null}M=null;for(var X in swfobject){swfobject[X]=null}swfobject=null})}}();return{registerObject:function(ab,X,aa,Z){if(M.w3&&ab&&X){var Y={};Y.id=ab;Y.swfVersion=X;Y.expressInstall=aa;Y.callbackFn=Z;o[o.length]=Y;w(ab,false)}else{if(Z){Z({success:false,id:ab})}}},getObjectById:function(X){if(M.w3){return z(X)}},embedSWF:function(ab,ah,ae,ag,Y,aa,Z,ad,af,ac){var X={success:false,id:ah};if(M.w3&&!(M.wk&&M.wk<312)&&ab&&ah&&ae&&ag&&Y){w(ah,false);K(function(){ae+="";ag+="";var aj={};if(af&&typeof af===r){for(var al in af){aj[al]=af[al]}}aj.data=ab;aj.width=ae;aj.height=ag;var am={};if(ad&&typeof ad===r){for(var ak in ad){am[ak]=ad[ak]}}if(Z&&typeof Z===r){for(var ai in Z){if(typeof am.flashvars!=D){am.flashvars+="&"+ai+"="+Z[ai]}else{am.flashvars=ai+"="+Z[ai]}}}if(F(Y)){var an=u(aj,am,ah);if(aj.id==ah){w(ah,true)}X.success=true;X.ref=an}else{if(aa&&A()){aj.data=aa;P(aj,am,ah,ac);return}else{w(ah,true)}}if(ac){ac(X)}})}else{if(ac){ac(X)}}},switchOffAutoHideShow:function(){m=false},ua:M,getFlashPlayerVersion:function(){return{major:M.pv[0],minor:M.pv[1],release:M.pv[2]}},hasFlashPlayerVersion:F,createSWF:function(Z,Y,X){if(M.w3){return u(Z,Y,X)}else{return undefined}},showExpressInstall:function(Z,aa,X,Y){if(M.w3&&A()){P(Z,aa,X,Y)}},removeSWF:function(X){if(M.w3){y(X)}},createCSS:function(aa,Z,Y,X){if(M.w3){v(aa,Z,Y,X)}},addDomLoadEvent:K,addLoadEvent:s,getQueryParamValue:function(aa){var Z=j.location.search||j.location.hash;if(Z){if(/\?/.test(Z)){Z=Z.split("?")[1]}if(aa==null){return L(Z)}var Y=Z.split("&");for(var X=0;X<Y.length;X++){if(Y[X].substring(0,Y[X].indexOf("="))==aa){return L(Y[X].substring((Y[X].indexOf("=")+1)))}}}return""},expressInstallCallback:function(){if(a){var X=c(R);if(X&&l){X.parentNode.replaceChild(l,X);if(Q){w(Q,true);if(M.ie&&M.win){l.style.display="block"}}if(E){E(B)}}a=false}}}}();function createContainer(){if(typeof document!="undefined"){clearInterval(ts);if(this.swfContainer!=null){var div=document.getElementById(this.swfContainer);if(div==null){throw new Error("NO_SWF_CONTAINER")}if(div.offsetWidth<215){div.style.minWidth=div.style.width=215+"px"}if(div.offsetHeight<138){div.style.minHeight=div.style.height=138+"px"}}else{div=document.createElement("div");this.swfContainer=div.id="voximplantcontainer";div.style.minWidth=div.style.width=215+"px";div.style.minHeight=div.style.height=138+"px";if(document.body.firstChild){document.body.insertBefore(div,document.body.firstChild)}else{document.body.appendChild(div)}}var div2=document.createElement("div");div2.id="voximplantcontainerSWF";div.appendChild(div2);var attributes={id:"voximplantSWF",name:"voximplantSWF"};var flashvars=false;var params={allowScriptAccess:"always",wmode:"window"};window.VILog=function(str){if(typeof console!="undefined"){console.log(str)}};window.voxImplantFlashAPIReady=swfLoaded.bind(this);swfobject.embedSWF(("https:"==document.location.protocol?"https://":"http://")+"cdn.voximplant.com/VoxImplant.swf?ver=161213","voximplantcontainerSWF","100%","100%","11.3",null,flashvars,params,attributes)}}var ts=setInterval(createContainer.bind(this),100)}else{throw new Error("NO_WEBRTC_SUPPORT")}}function swfLoaded(){this.dispatchEvent({name:"SDKReady"});var aSources=JSON.parse(VoxImplant.Utils.swfMovie("voximplantSWF").audioSources());var vSources=JSON.parse(VoxImplant.Utils.swfMovie("voximplantSWF").videoSources());for(var i=0;i<aSources.length;i++){this.audioSourcesList.push({id:i,name:aSources[i]})}for(i=0;i<vSources.length;i++){this.videoSourcesList.push({id:i,name:vSources[i]})}this.dispatchEvent({name:"SourcesInfoUpdated"})}window.VIConnectionEstablished=function(){this.connectionState(true);this.dispatchEvent({name:"ConnectionEstablished"})}.bind(this);window.VIConnectionFailed=function(){if(this.serversList.length>1&&typeof(this.serverIp)=="undefined"){this.serversList.splice(0,1);this.connectTo(this.serversList[0],true)}else{this.dispatchEvent({name:"ConnectionFailed"})}}.bind(this);window.VIConnectionClosed=function(){this.connectionState(false);this.dispatchEvent({name:"ConnectionClosed"});if(this.progressTone){this.stopProgressTone()}}.bind(this);window.VIAuthResult=function(res,code,key){this.dispatchEvent({name:"AuthResult",result:res,code:code,key:key})}.bind(this);window.VICallConnected=function(id){this.getCall(id).dispatchEvent({name:"Connected",call:this.getCall(id)});if(this.progressTone){this.stopProgressTone()}}.bind(this);window.VICallDisconnected=function(id){this.getCall(id).dispatchEvent({name:"Disconnected",call:this.getCall(id)});this.removeCall(id);if(this.progressTone){this.stopProgressTone()}}.bind(this);window.VICallFailed=function(id,code,reason){this.getCall(id).dispatchEvent({name:"Failed",call:this.getCall(id),code:code,reason:reason});this.removeCall(id);if(this.progressTone){this.stopProgressTone()}}.bind(this);window.VIMicAccessResult=function(res){this.dispatchEvent({name:"MicAccessResult",result:res})}.bind(this);window.VIProgressToneStart=function(id){this.getCall(id).dispatchEvent({name:"ProgressToneStart",call:this.getCall(id)});if(this.progressTone){this.playProgressTone()}}.bind(this);window.VIProgressToneStop=function(id){this.getCall(id).dispatchEvent({name:"ProgressToneStop",call:this.getCall(id)});if(this.progressTone){this.stopProgressTone()}}.bind(this);window.VIIncomingCall=function(id,num,displayName,headers){var newCall=new Call(id,num,displayName,headers!=null?JSON.parse(headers):{},false);this.calls.push(newCall);this.dispatchEvent({name:"IncomingCall",call:newCall})}.bind(this);window.VISIPInfoReceived=function(id,type,subtype,body,headers){if(type=="application"&&subtype=="zingaya-im"){this.getCall(id).dispatchEvent({name:"MessageReceived",call:this.getCall(id),text:body})}else{if(headers!=null){headers=JSON.parse(headers)}this.getCall(id).dispatchEvent({name:"InfoReceived",call:this.getCall(id),mimeType:type+"/"+subtype,body:body,headers:headers})}}.bind(this);window.VIToneScriptPlaybackStop=function(){this.dispatchEvent({name:"PlaybackFinished"})}.bind(this)},this.connectionState=function(b){if(typeof b=="undefined"){return _connected}else{_connected=b}};this.getCall=function(call){for(var i=0;i<this.calls.length;i++){if(this.calls[i].call()==call){return this.calls[i]}}return null};this.removeCall=function(call){var newCallsArray=new Array();for(var i=0;i<this.calls.length;i++){if(this.calls[i].call()!=call){newCallsArray.push(this.calls[i])}else{delete this.calls[i]}}this.calls=newCallsArray};this.playProgressTone=function(){if(this.progressToneScript[this.progressToneCountry]!=null){if(!this.playingNow){this.playToneScript(this.progressToneScript[this.progressToneCountry])}this.playingNow=true}};this.stopProgressTone=function(){if(this.playingNow){this.stopPlayback();this.playingNow=false}};this.__call=function(num,useVideo,customData,extraHeaders){if(typeof customData!="undefined"){if(typeof extraHeaders=="undefined"){extraHeaders=new Object()}extraHeaders["VI-CallData"]=customData}if(!this.connectionState()){throw new Error("NOT_CONNECTED_TO_VOXIMPLANT")}if(this.RTCsupported&&!this.useFlashOnly){var RTCcall=this.zingayaAPI.call(num,useVideo,extraHeaders);var newCall=new Call(RTCcall,num,"",extraHeaders,true,this.zingayaAPI)}else{if(!this.useRTCOnly){extraHeaders=JSON.stringify(extraHeaders);var call_id=VoxImplant.Utils.swfMovie("voximplantSWF").call(num,useVideo,null,extraHeaders);newCall=new Call(call_id,num,"",extraHeaders,false)}}this.calls.push(newCall);return newCall};this.__volume=function(vol){if(typeof vol=="undefined"){return _vol}else{_vol=vol}}};VoxImplant.Client.prototype={call:function(num,useVideo,customData,extraHeaders){return this.__call(num,useVideo,customData,extraHeaders)},config:function(){return this.config},connect:function(){VoxImplant.Utils.getServers(balancerResult.bind(this),false,this);function balancerResult(data){var ind=String(data).indexOf(";");if(ind==-1){host=data}else{this.serversList=data.split(";");host=this.serversList[0]}if(typeof(this.serverIp)!="undefined"){host=this.serverIp}this.connectTo(host)}},connectTo:function(host,omitMicDetection){this.host=host;if(this.RTCsupported&&!this.useFlashOnly){if(!this.micRequired||omitMicDetection===true){this.zingayaAPI.connectTo(host,"platform")}else{this.zingayaAPI.queryMedia(this.onMicAccessAllowed,this.onMicAccessDenied,this.videoSupport)}}else{if(!this.useRTCOnly){VoxImplant.Utils.swfMovie("voximplantSWF").connect(host,omitMicDetection===true?false:this.micRequired,this.micRequired&&this.showFlashSettings)}}},disconnect:function(){if(!this.connectionState()){throw new Error("NOT_CONNECTED_TO_VOXIMPLANT")}if(this.RTCsupported&&!this.useFlashOnly){this.zingayaAPI.disconnect()}else{if(!this.useRTCOnly){VoxImplant.Utils.swfMovie("voximplantSWF").disconnect()}}},init:function(config){this.__init(config)},login:function(username,password){if(!this.connectionState()){throw new Error("NOT_CONNECTED_TO_VOXIMPLANT")}if(this.RTCsupported&&!this.useFlashOnly){this.zingayaAPI.login(username,password)}else{if(!this.useRTCOnly){VoxImplant.Utils.swfMovie("voximplantSWF").login(username,password)}}},loginWithCode:function(username,code){if(!this.connectionState()){throw new Error("NOT_CONNECTED_TO_VOXIMPLANT")}if(this.RTCsupported&&!this.useFlashOnly){this.zingayaAPI.loginStage2(username,code)}else{if(!this.useRTCOnly){VoxImplant.Utils.swfMovie("voximplantSWF").loginStage2(username,code)}}},requestOneTimeLoginKey:function(username){if(!this.connectionState()){throw new Error("NOT_CONNECTED_TO_VOXIMPLANT")}if(this.RTCsupported&&!this.useFlashOnly){this.zingayaAPI.requestOneTimeLoginKey(username)}else{if(!this.useRTCOnly){VoxImplant.Utils.swfMovie("voximplantSWF").requestOneTimeLoginKey(username)}}},loginWithOneTimeKey:function(username,hash){if(!this.connectionState()){throw new Error("NOT_CONNECTED_TO_VOXIMPLANT")}if(this.RTCsupported&&!this.useFlashOnly){this.zingayaAPI.loginUsingOneTimeKey(username,hash)}else{if(!this.useRTCOnly){VoxImplant.Utils.swfMovie("voximplantSWF").loginUsingOneTimeKey(username,hash)}}},setPresence:function(state){if(!this.connectionState()){throw new Error("NOT_CONNECTED_TO_VOXIMPLANT")}if(this.RTCsupported&&!this.useFlashOnly){this.zingayaAPI.setPresence(state)}else{if(!this.useRTCOnly){VoxImplant.Utils.swfMovie("voximplantSWF").setPresence(state)}}},connected:function(){return this.connectionState()},showLocalVideo:function(flag){if(typeof flag=="undefined"){flag=true}if(this.RTCsupported&&!this.useFlashOnly){if(flag){if(document.getElementById("voximplantlocalvideo")==null){var element=document.createElement("video");element.id="voximplantlocalvideo";element.autoplay="autoplay";element.muted="true";if(document.body.firstChild){document.body.insertBefore(element,document.body.firstChild)}else{document.body.appendChild(element)}this.zingayaAPI.attachLocalVideoToSink(element)}else{document.getElementById("voximplantlocalvideo").style.display="block"}}else{document.getElementById("voximplantlocalvideo").style.display="none"}}else{if(!this.useRTCOnly){VoxImplant.Utils.swfMovie("voximplantSWF").showLocalVideo(flag)}}},setLocalVideoPosition:function(x,y){if(this.RTCsupported&&!this.useFlashOnly){throw new Error("Please use CSS to position '#voximplantlocalvideo' element")}else{if(!this.useRTCOnly){VoxImplant.Utils.swfMovie("voximplantSWF").setSelfViewPosition(x,y)}}},setLocalVideoSize:function(width,height){if(this.RTCsupported&&!this.useFlashOnly){throw new Error("Please use CSS to set size of '#voximplantlocalvideo' element")}else{if(!this.useRTCOnly){VoxImplant.Utils.swfMovie("voximplantSWF").setSelfViewSize(width,height)}}},setVideoSettings:function(settings){if(this.RTCsupported&&!this.useFlashOnly){this.zingayaAPI.setConstraints(settings,function(){if(document.getElementById("voximplantlocalvideo")!=null){this.zingayaAPI.attachLocalVideoToSink(document.getElementById("voximplantlocalvideo"))}}.bind(this))}else{if(!this.useRTCOnly){if(Object.prototype.toString.call(settings)=="[object Object]"){settings=JSON.stringify(settings)}VoxImplant.Utils.swfMovie("voximplantSWF").setVideoSettings(settings)}}},playToneScript:function(script,loop){if(this.RTCsupported&&!this.useFlashOnly){VoxImplant.Utils.playToneScript(script,loop)}else{if(!this.useRTCOnly){VoxImplant.Utils.swfMovie("voximplantSWF").playToneScript(script,loop)}}},stopPlayback:function(){if(this.RTCsupported&&!this.useFlashOnly){if(VoxImplant.Utils.stopPlayback()){this.dispatchEvent({name:"PlaybackFinished"})}}else{if(!this.useRTCOnly){VoxImplant.Utils.swfMovie("voximplantSWF").stopPlayback()}}},volume:function(vol){if(typeof vol=="undefined"){return this.__volume()}else{if(vol>100){vol=100}if(vol<0){vol=0}if(this.RTCsupported&&!this.useFlashOnly){document.getElementById("voximplantcontainer").volume=vol/100}else{if(!this.useRTCOnly){VoxImplant.Utils.swfMovie("voximplantSWF").changeIncomingAudioVolume(vol)}}this.__volume(vol)}},audioSources:function(){if(this.RTCsupported&&!this.useFlashOnly){if(!this.deviceEnumAPI){throw new Error("NOT_SUPPORTED [MediaStreamTrack.getSources]")}}return this.audioSourcesList},videoSources:function(){if(this.RTCsupported&&!this.useFlashOnly){if(!this.deviceEnumAPI){throw new Error("NOT_SUPPORTED [MediaStreamTrack.getSources]")}}return this.videoSourcesList},useAudioSource:function(id,successCallback,failedCallback){if(this.RTCsupported&&!this.useFlashOnly){this.zingayaAPI.useAudioSource(id,successCallback,failedCallback)}else{if(!this.useRTCOnly){VoxImplant.Utils.swfMovie("voximplantSWF").setAudioSource(id)}}},useVideoSource:function(id,successCallback,failedCallback){if(this.RTCsupported&&!this.useFlashOnly){this.zingayaAPI.useVideoSource(id,function(){if(document.getElementById("voximplantlocalvideo")!=null){this.zingayaAPI.attachLocalVideoToSink(document.getElementById("voximplantlocalvideo"))}if(typeof successCallback=="function"){successCallback()}}.bind(this),failedCallback)}else{if(!this.useRTCOnly){VoxImplant.Utils.swfMovie("voximplantSWF").setVideoSource(id)}}},attachRecordingDevice:function(successCallback,failedCallback){if(this.RTCsupported&&!this.useFlashOnly&&!this.micRequired){this.zingayaAPI.queryMedia(successCallback,failedCallback,this.videoSupport)}},showFlashSettingsPanel:function(panel){if(typeof panel=="undefined"){panel="default"}if(this.RTCsupported&&!this.useFlashOnly){}else{if(!this.useRTCOnly){VoxImplant.Utils.swfMovie("voximplantSWF").showFlashSettings(panel)}}}};VoxImplant.Client.prototype.addEventListener=function(event,handler){if(typeof(this.eventListeners[event])=="undefined"){this.eventListeners[event]=[]}this.eventListeners[event].push(handler)};VoxImplant.Call.prototype.addEventListener=function(event,handler){if(typeof(this.eventListeners[event])=="undefined"){this.eventListeners[event]=[]}this.eventListeners[event].push(handler)};VoxImplant.Client.prototype.removeEventListener=function(event,handler){if(typeof(this.eventListeners[event])=="undefined"){return}for(var i=0;i<this.eventListeners[event].length;i++){if(this.eventListeners[event][i]==handler){this.eventListeners[event].splice(i,1);break}}};VoxImplant.Call.prototype.removeEventListener=function(event,handler){if(typeof(this.eventListeners[event])=="undefined"){return}for(var i=0;i<this.eventListeners[event].length;i++){if(this.eventListeners[event][i]==handler){this.eventListeners[event].splice(i,1);break}}};VoxImplant.Client.prototype.dispatchEvent=VoxImplant.Call.prototype.dispatchEvent=function(e){var event=e.name;if(typeof this.eventListeners[event]!="undefined"){for(var i=0;i<this.eventListeners[event].length;i++){if(typeof this.eventListeners[event][i]=="function"){this.eventListeners[event][i](e)}}}};VoxImplant.getInstance=function(){return VoxImplant._clientInstance};VoxImplant.Config={};VoxImplant.FlashVideoSettings={};VoxImplant.VideoSettings={};VoxImplant.AudioSourceInfo={};VoxImplant.VideoSourceInfo={};VoxImplant.Events={SDKReady:"SDKReady",ConnectionEstablished:"ConnectionEstablished",ConnectionFailed:"ConnectionFailed",ConnectionClosed:"ConnectionClosed",AuthResult:"AuthResult",PlaybackFinished:"PlaybackFinished",MicAccessResult:"MicAccessResult",IncomingCall:"IncomingCall",SourcesInfoUpdated:"SourcesInfoUpdated"};VoxImplant.CallEvents={Connected:"Connected",Disconnected:"Disconnected",Failed:"Failed",ProgressToneStart:"ProgressToneStart",ProgressToneStop:"ProgressToneStop",MessageReceived:"MessageReceived",InfoReceived:"InfoReceived"};if(!VoxImplant._clientInstance){VoxImplant._clientInstance=new VoxImplant.Client();delete VoxImplant.Client}})(window.VoxImplant=window.VoxImplant||{});(function(a,d){var c=10000;var b=10000;a.ZingayaCall=function(l,k,i,g){var h=l;var e=k;var j=i;var f=g;this.state=function(m){if(typeof(m)=="undefined"){return f}else{f=m}};this.id=function(){return h};this.remote=function(){return e};this.remoteDisplayName=function(){return j};this.dump=function(){return"Call@"+h+". Remote party - "+(j==null?e:'"'+j+'" <'+e+">")+". State "+f}};a.ZingayaCall.prototype={remote:function(){return this.remote()}};a.ZingayaAPI=function(f){this.videoSupport=f?true:false;var g=function(){this.offerSent=0;this.lastCallId=0;this.connId="";this.localStream=null;this.connected=false;this.iceComplete=false;this.connecting=false;this.offer=null;this.actionNeeded=false;this.iceStarted=false;this.moreIceComing=true;this.iceCandidateCount=0;this.state="no-connection-created";this.noFirstLoad=0;this.noFirstLoad2=0;this.iceCandidateNumber=0;this.mediaConstraints={mandatory:{OfferToReceiveAudio:true,OfferToReceiveVideo:this.videoSupport}};this.log_level=true;this.log_level1=true;this.log_level2=false;this.ms=new Date();this.sock=0;this.timerId=0;this.needConnect=false;this.connectionProtocol="wss";this.rtpCandidateGenerated=false;this.rtcpCandidateGenerated=false;this.rtpVideoCandidateGenerated=false;this.rtcpVideoCandidateGenerated=false;this.localRTCPMux=false;this.isChrome=(typeof(webkitRTCPeerConnection)!="undefined");this.isFirefox=(typeof(mozRTCPeerConnection)!="undefined");this.deviceEnumAPI=(typeof MediaStreamTrack!="undefined")&&(typeof MediaStreamTrack.getSources!="undefined");this.audioSourceId=null;this.videoSourceId=null;this.videoConstraints=null;this.localDisplayName=null;this.remoteSDP=null;this.localSDP=null;this.loginSuccessCallback=null;this.loginFailedCallback=null;this.connectionSuccessCallback=null;this.connectionFailedCallback=null;this.connectionClosedCallback=null;this.calls={};this.pingTimeout=null;this.pongTimeout=null};this.reset=function(){if(this.sock){this.sock.close();delete this.sock}g.bind(this)()};g.bind(this)();if(this.isFirefox){RTCPeerConnection=mozRTCPeerConnection;getUserMedia=navigator.mozGetUserMedia.bind(navigator);attachMediaStream=function(h,i){h.mozSrcObject=i;h.play()}}if(this.isChrome){RTCPeerConnection=webkitRTCPeerConnection;getUserMedia=navigator.webkitGetUserMedia.bind(navigator);attachMediaStream=function(h,i){h.src=webkitURL.createObjectURL(i)}}var e=a.ZingayaCall;delete a.ZingayaCall;this.call=function(h,k,l,n){try{var m=this.makeid(36);this.currentCallId=m;waitingForStream=false;this.log("Call.......");this.setStreamActive();this.log("zingayaAPI.to=%s, zingayaAPI.useVideo=%s, zingayaAPI.currentCallId=%s",h,k,m);var j=new e(m,h,null,"PROGRESSING");this.callServerMethod("createCall",[-1,h,k,m,null,null,l,n]);this.callServerMethod("setActiveCall",[this.currentCallId]);this.calls[m]=j;return j}catch(i){this.log("call: "+i);return null}};this.onWSDataReceived=function(m){var u=JSON.parse(m.data);var r=u.name;if(r!="increaseGain"&&(r!="__pong"||this.log_level2)){this.log(r)}if(r==="signalingMessage"){var o=u.params[0];this.log("----------------------------");this.log(o);this.log("----------------------------");var l=JSON.parse(o);this.log("--ANSWER--------------------------");this.log(l.sdp);this.log("-----------------");if(this.state==="established"){}else{this.setRemoteDescription(o)}}if(r=="handleSIPInfo"){var i=u.params[1];var j=u.params[2];var p=u.params[3];var k=u.params[4];if(i=="application"&&j=="zingaya-im"){if(this.onMessage){this.onMessage(this.calls[u.params[0]],p)}}else{if(this.onSIPInfo){this.onSIPInfo(this.calls[u.params[0]],i+"/"+j,p,k)}}}if(r=="streamCreated"){if(this.discardCall){if(this.onCallFailed){this.onCallFailed(this.calls[currentCallId],"487","Request Terminated")}this.currentCallId=null;this.discardCall=false}else{this.callServerMethod("createCall",[-1,this.to,this.useVideo,this.currentCallId],function(){this.peerConn.addStream(this.localStream);this.callServerMethod("setActiveCall",[this.currentCallId])}.bind(this))}}if(r=="handlePreFlightCheckResult"){this.setStreamInactive();if(this.onCheckResult){this.onCheckResult(u.params[0],u.params[1])}}if(r=="handleConnectionConnected"){var s=this.calls[u.params[0]];if(typeof(s)!="undefined"){s.state("CONNECTED");if(this.onCallConnected){this.onCallConnected(s)}}this.setStreamActive()}if(r=="handleVoicemail"){if(this.onVoicemail){this.onVoicemail(u.params[0])}}if(r=="handleIncomingConnection"){var h=u.params[0];var s=new e(h,u.params[1],u.params[2],"ALERTING");this.calls[h]=s;this.callServerMethod("setActiveCall",[h]);this.setStreamActive();if(this.onIncomingCall){this.onIncomingCall(s,u.params[3])}else{this.hangup(s)}}if(r=="handleConnectionDisconnected"){this.callServerMethod("destroyOutgoingStream",[]);var s=this.calls[u.params[0]];if(typeof(s)!="undefined"){delete this.calls[u.params[0]];if(this.getNumCalls()==0){this.setStreamInactive()}s.state("ENDED");if(this.onCallDisconnected){this.onCallDisconnected(s)}}}if(r=="handleRingOut"){var s=this.calls[u.params[0]];if(typeof(s)!="undefined"){if(this.onPlayProgressTone){this.onPlayProgressTone(s)}}}if(r=="peerConnectionReady"){this.log("peerConnectionReady");if(this.connectionSuccessCallback){this.connectionSuccessCallback()}}if(r=="peerConnectionError"){this.log("peerConnectionError");try{sock.close();sock=0;peerConn.close();peerConn=0}catch(q){this.log("Exception: "+q)}if(this.connectionFailedCallback){this.connectionFailedCallback("Can't establish PeerConnection")}}if(r=="stopRinging"){var s=this.calls[u.params[0]];if(typeof(s)!="undefined"){if(this.onStopPlayingProgressTone){this.onStopPlayingProgressTone(s)}}}if(r=="handleConnectionFailed"){var s=this.calls[u.params[0]];if(typeof(s)!="undefined"){delete this.calls[u.params[0]];s.state("ENDED");if(this.getNumCalls()==0){this.setStreamInactive()}if(this.onCallFailed){this.onCallFailed(s,u.params[1],u.params[2])}}}if(r=="onMediaPreloadSuccess"){if(this.onMediaPreloadSuccess){this.onMediaPreloadSuccess()}}if(r=="onMediaPreloadError"){if(this.onMediaPreloadError){this.onMediaPreloadError()}}if(r=="loginSuccessful"){this.localDisplayName=u.params[0];if(this.loginSuccessCallback){this.loginSuccessCallback()}}if(r=="loginFailed"){if(this.loginFailedCallback){this.loginFailedCallback({errorCode:u.params[0],type:"LoginError",oneTimeKey:u.params[1]})}}if(r=="__pong"){if(this.pongTimeout){clearTimeout(this.pongTimeout);this.pingTimeout=setTimeout(this.onPingTimeout.bind(this),c)}}}};a.ZingayaAPI.prototype={getNumCalls:function(){var f=0;for(var e in this.calls){f++}return f},log:function(e){if(this.log_level==true){console.log(e)}},log1:function(e){if(this.log_level1==true){console.log(e)}},log2:function(e){if(this.log_level2==true){console.log(e)}},onDisconnectError:function(){if(this.state!="no-connection-created"){this.state="no-connection-created";this.connected=false;this.offerSent=0;this.needConnect=false;if(this.onCallDisconnected){this.onCallDisconnected()}if(this.networkProblem){this.networkProblem()}}},useAudioSource:function(h,e,f,g){if(this.deviceEnumAPI){this.audioSourceId=h;this.queryMedia(e,f,g,false)}},useVideoSource:function(g,e,f){if(this.deviceEnumAPI){this.videoSourceId=g;this.queryMedia(e,f,true,true)}},setConstraints:function(g,e,f){this.videoConstraints=g;this.queryMedia(e,f,true,true)},queryMedia:function(f,h,i,e){try{if(this.audioSourceId==null&&this.videoSourceId==null){var j={audio:true,video:i===true?true:false}}else{if(this.audioSourceId!=null&&this.videoSourceId!=null){var j={audio:{optional:[{sourceId:this.audioSourceId}]},video:{optional:[{sourceId:this.videoSourceId}]}}}else{if(this.audioSourceId!=null){var j={audio:{optional:[{sourceId:this.audioSourceId}]},video:i===true?true:false}}else{if(this.videoSourceId!=null){var j={audio:true,video:{optional:[{sourceId:this.videoSourceId}]}}}}}}if(this.videoConstraints!=null){j.video=new Object();if(typeof this.videoConstraints.mandatory!="undefined"){j.video.mandatory=this.videoConstraints.mandatory}if(typeof this.videoConstraints.optional!="undefined"){j.video.optional=this.videoConstraints.optional;if(this.videoSourceId!=null){j.video.optional.push({sourceId:this.videoSourceId})}}else{if(this.videoSourceId!=null){j.video.optional=[{sourceId:this.videoSourceId}]}}}if(this.localStream!=null&&e){this.localStream.stop()}getUserMedia(j,function(k){if(this.localStream==null){this.localStream=k;if(this.peerConn!=null){this.peerConn.addStream(this.localStream)}}else{if(this.peerConn){this.peerConn.removeStream(this.localStream);this.peerConn.addStream(k)}this.localStream=k}this.log("stream "+this.localStream.label);if(typeof f!="undefined"){f()}}.bind(this),function(k){if(typeof h=="function"){h(k)}})}catch(g){this.log("queryMedia: "+g)}},mute:function(){this.audioTracksEnabled(false)},unmute:function(){this.audioTracksEnabled(true)},muteMicrophone:function(){this.localAudioTracksEnabled(false)},unmuteMicrophone:function(){this.localAudioTracksEnabled(true)},mutePlayback:function(){this.remoteAudioTracksEnabled(false)},unmutePlayback:function(){this.remoteAudioTracksEnabled(true)},voicemailPromptFinished:function(f){try{this.callServerMethod("promptFinished",[f])}catch(e){this.log("voicemailPromptFinished: "+e)}},localAudioTracksEnabled:function(f){try{if(this.getLocalStreams()){if(this.getLocalStreams().length!=0){if(this.getAudioTracks(this.getLocalStreams()[0])){if(this.getAudioTracks(this.getLocalStreams()[0]).length!=0){this.getAudioTracks(this.getLocalStreams()[0])[0].enabled=f}}}}}catch(e){this.log("localAudioTracksEnabled: "+e)}},localVideoTracksEnabled:function(f){try{if(this.getLocalStreams()){if(this.getLocalStreams().length!=0){if(this.getVideoTracks(this.getLocalStreams()[0])){if(this.getVideoTracks(this.getLocalStreams()[0]).length!=0){this.getVideoTracks(this.getLocalStreams()[0])[0].enabled=f}}}}}catch(e){this.log("localVideoTracksEnabled: "+e)}},remoteAudioTracksEnabled:function(f){try{if(this.getRemoteStreams()){if(this.getRemoteStreams().length!=0){if(this.getAudioTracks(this.getRemoteStreams()[0])){if(this.getAudioTracks(this.getRemoteStreams()[0]).length!=0){this.getAudioTracks(this.getRemoteStreams()[0])[0].enabled=f}}}}}catch(e){this.log("remoteAudioTracksEnabled: "+e)}},getAudioTracks:function(e){if(e.audioTracks){return e.audioTracks}if(e.getAudioTracks){return e.getAudioTracks()}return null},getVideoTracks:function(e){if(e.videoTracks){return e.videoTracks}if(e.getVideoTracks){return e.getVideoTracks()}return null},getLocalStreams:function(){if(this.peerConn.localStreams){return this.peerConn.localStreams}else{return this.peerConn.getLocalStreams()}},getRemoteStreams:function(){if(this.peerConn.remoteStreams){return this.peerConn.remoteStreams}else{return this.peerConn.getRemoteStreams()}},audioTracksEnabled:function(f){try{this.remoteAudioTracksEnabled(f);this.localAudioTracksEnabled(f)}catch(e){this.log("stopStream: "+e)}},onRenegotiate:function(){if(this.remoteSDP!=null){this.peerConn.setRemoteDescription(this.remoteSDP,this.createAnswer.bind(this),this.failed)}},createPeerConnection:function(){try{var f=null;this.peerConn=new RTCPeerConnection(f,{optional:[{DtlsSrtpKeyAgreement:"true"}]});this.peerConn.onicecandidate=this.onIceCandidate.bind(this);this.peerConn.onaddstream=this.remoteStreamAdded.bind(this);this.peerConn.onnegotiationneeded=this.onRenegotiate.bind(this);this.addStream();this.callServerMethod("createOffer",this.videoSupport)}catch(g){this.log("createPeerConnection: "+g+" "+g.stack)}},addStream:function(){try{this.peerConn.addStream(this.localStream);this.log("addStream")}catch(e){this.log("addStream: "+e)}},onIceCandidate:function(g){try{if(g.candidate){var f=g.candidate.candidate;if(f.indexOf("1 udp")!=-1){if(g.candidate.sdpMid=="audio"){this.rtpCandidateGenerated=true}else{this.rtpVideoCandidateGenerated=true}}if(f.indexOf("2 udp")!=-1){if(g.candidate.sdpMid=="audio"){this.rtcpCandidateGenerated=true}else{this.rtcpVideoCandidateGenerated=true}}if(this.rtpCandidateGenerated&&(this.rtcpCandidateGenerated||this.localRTCPMux)&&((this.rtpVideoCandidateGenerated&&(this.rtcpVideoCandidateGenerated||this.localRTCPMux))||!this.videoSupport)){this.iceComplete=true;if(this.offerSent===0){this.peerConn.createAnswer(this.setLocalAndSendMessageOffer.bind(this),null,this.mediaConstraints)}}}else{this.log("End of candidates.")}}catch(h){this.log("Error: "+h)}},removeStream:function(){try{this.log("removeStream");if(this.connectionFailed){this.connectionFailed("removeStream")}}catch(e){this.log("removeStream: "+e)}},attachStreamToElement:function(f,e){attachMediaStream(e,f)},attachLocalVideoToSink:function(e){this.attachStreamToElement(this.localStream,e)},remoteStreamAdded:function(f){try{this.incomingStream=f.stream;if(this.onStreamAdded){this.onStreamAdded(f.stream)}this.connected=true;this.attachStreamToElement(this.incomingStream,this.audioSink)}catch(e){this.log("remoteStreamAdded :"+e)}},makeid:function(e){var h="";var f="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(var g=0;g<e;g++){h+=f.charAt(Math.floor(Math.random()*f.length))}return h},loop:function(e){this.callServerMethod("loop",[e])},onPingTimeout:function(){this.pingTimeout=null;this.callServerMethod("__ping");this.pongTimeout=setTimeout(function(){this.disconnect()}.bind(this),b)},onWSConnected:function(){this.pingTimeout=setTimeout(this.onPingTimeout.bind(this),c);this.log("WS connected");this.createPeerConnection();this.state="new"},disconnect:function(){if(this.sock){this.sock.onclose=null;this.sock.close();this.onWSClosed()}},onWSClosed:function(f){if(f!==d){if(f.target!=this.sock){return}}if(this.pingTimeout){clearTimeout(this.pingTimeout);this.pingTimeout=null}if(this.pongTimeout){clearTimeout(this.pongTimeout);this.pongTimeout=null}this.log("WS closed");this.offerSent=0;this.sock=0;if(this.peerConn){this.peerConn.close();this.peerConn=null}if(this.connectionClosedCallback){this.connectionClosedCallback()}},onWSError:function(f){if(f.target!=this.sock){return}this.log("WS error");this.offerSent=0;if(this.peerConn){this.peerConn.close();this.peerConn=null}this.sock=0;if(this.connectionFailedCallback){this.connectionFailedCallback("Error connecting to Zignaya server "+f)}},offerCallback:function(g,f){try{this.log(" offerCallback, successful = "+g)}catch(e){this.log("offerCallback: "+e);if(this.connectionFailed){this.connectionFailed("error in offerCallback during connection")}}},failed:function(e){this.log("Error: "+e)},createAnswer:function(){try{this.peerConn.createAnswer(this.setLocalAndSendMessageOffer.bind(this),this.failed)}catch(f){this.log("Error: "+f)}},setRemoteDescription:function(h){try{var f=JSON.parse(h);var g=null;if(this.isChrome){g=new RTCSessionDescription(f)}else{if(mozRTCSessionDescription!==d){g=new mozRTCSessionDescription(f)}}this.remoteSDP=g;this.peerConn.setRemoteDescription(g,this.createAnswer.bind(this),this.failed);this.state="established"}catch(e){this.log("offerCallback: "+e);if(this.connectionFailed){this.connectionFailed("error in setRemoteDescription during connection")}}},setLocalAndSendMessageOffer:function(g){try{this.peerConn.setLocalDescription(g);var f=g.sdp;this.localSDP=g;if((this.offerSent===0)&&(this.needConnect===true)){this.localRTCPMux=f.indexOf("a=rtcp-mux")!=-1;if(f.indexOf("candidate")!=-1){this.offerSent=1;this.log("----send "+g.type+"-----");this.log(f);this.sendMessage(g.type,g,this.offerCallback)}else{this.log("bad Offer without candidate")}}}catch(e){this.log("setLocalAndSendMessageOffer: "+e);if(this.connectionFailed){this.connectionFailed("error in Offer during connection")}}},sendMessage:function(i,g,h){try{var f={app:"zingaya",client:"chrome_2",type:g.type,sdp:g.sdp};this.callServerMethod("processJSEP",f,h,this)}catch(e){this.log("sendMessage: "+e)}},sendMessage2:function(e,i,h,g){try{this.log("x="+e.candidate)}catch(f){this.log("sendMessage: "+f)}},callServerMethod:function(g,i,f,h){try{if(typeof Array.prototype.toJSON!="undefined"||typeof String.prototype.toJSON!="undefined"){this.sock.send(VoxImplantJSON.stringify({name:g,params:i}))}else{this.sock.send(JSON.stringify({name:g,params:i}))}}catch(e){this.log("callServerMethod: "+e)}},startPreFlightCheck:function(f,e){this.setStreamActive();this.callServerMethod("startPreFlightCheck",[f,e])},preloadMedia:function(e){this.callServerMethod("preloadMedia",[e])},renegotiateSDP:function(){this.peerConn.setRemoteDescription(this.remoteSDP,function(){this.peerConn.setLocalDescription(this.localSDP)}.bind(this))},setStreamActive:function(){this.remoteSDP.sdp=this.remoteSDP.sdp.replace("a=inactive","a=sendrecv");this.localSDP.sdp=this.localSDP.sdp.replace("a=inactive","a=sendrecv");this.renegotiateSDP();this.localAudioTracksEnabled(true)},setStreamInactive:function(){this.remoteSDP.sdp=this.remoteSDP.sdp.replace("a=sendrecv","a=inactive");this.localSDP.sdp=this.localSDP.sdp.replace("a=sendrecv","a=inactive");this.renegotiateSDP();this.localAudioTracksEnabled(false)},login:function(f,e){this.callServerMethod("login",[f,e])},loginStage2:function(f,e){this.callServerMethod("loginStage2",[f,e])},requestOneTimeLoginKey:function(e){this.callServerMethod("loginGenerateOneTimeKey",[e])},loginUsingOneTimeKey:function(f,e){this.callServerMethod("loginUsingOneTimeKey",[f,e])},connectTo:function(f,g,e){this.needConnect=true;if(this.sock==0){this.sock=new WebSocket(this.connectionProtocol+"://"+f+"/platform?client="+(this.isFirefox?"firefox":"chrome")+"&referrer="+encodeURIComponent(g)+"&extra="+encodeURIComponent(e));this.sock.onopen=function(h){this.onWSConnected(h)}.bind(this);this.sock.onclose=function(h){this.onWSClosed(h)}.bind(this);this.sock.onerror=function(h){this.onWSError(h)}.bind(this);this.sock.onmessage=function(h){this.onWSDataReceived(h)}.bind(this);this.calls={}}},setAudioSink:function(e){this.audioSink=e},sendSIPInfo:function(h,g,f,e,i){if(h.state()=="CONNECTED"){this.callServerMethod("sendSIPInfo",[h.id(),g,f,e,typeof(i)=="undefined"?{}:i])}},sendInstantMessage:function(e,f){if(e.state()=="CONNECTED"){this.callServerMethod("sendSIPInfo",[e.id(),"application","zingaya-im",f,{}])}},hangup:function(e,f){if(e.state()=="ALERTING"){this.callServerMethod("rejectCall",[e.id(),true,f])}else{this.callServerMethod("disconnectCall",[e.id(),f])}},sendDigit:function(e,f){this.callServerMethod("sendDTMF",[e.id(),f])},accept:function(e,f){if(e.state()=="ALERTING"){this.callServerMethod("acceptCall",[e.id(),f])}}}})(window.VoxImplant=window.VoxImplant||{});